# AmbonMUD Pre-v1.0 Code Review

**Date:** 2026-02-20
**Reviewer:** Claude Code (Sonnet 4.6 + Opus 4.6)
**Branch:** main @ 40f240d

---

## Executive Summary

The codebase is in good shape for a hobby/portfolio v1.0. The architecture is clean, the design contracts in `AGENTS.md` are well-observed, and the test coverage is meaningful. However, there are **two blocking bugs** that prevent players from accessing content, and a handful of medium-priority gaps worth closing before calling it 1.0.

---

## Critical / Blocking

### C1 — UP and DOWN movement commands are unimplemented
**File:** `engine/commands/CommandParser.kt` ~line 191
**Impact:** Players cannot move to rooms reached via `u`/`d` exits. The world already has these exits (`tower_base → tower_stairs`, `fissure_descent → undercroft_pool`). Typing `u`, `up`, `d`, or `down` produces `Command.Unknown`. The `look` command already handles up/down for directional look, making this asymmetry especially confusing.
**Fix:** Two lines in the `when` block:
```kotlin
"u", "up"   -> Command.Move(Direction.UP)
"d", "down" -> Command.Move(Direction.DOWN)
```

---

## High Priority

### H1 — Password input is silently trimmed
**File:** `engine/PlayerRegistry.kt` (`normalizePassword`), `engine/GameEngine.kt` (`handleLoginExistingPassword`)
**Impact:** Leading/trailing whitespace is stripped from passwords before hashing. A user who sets `" mypassword "` as their password will have `"mypassword"` stored. This is a silent data mutation at a security boundary. BCrypt already handles this correctly if you just don't trim.
**Fix:** Remove the `.trim()` call from password normalization. Apply trim only to names.

### H2 — `MobSystem.randomDelay()` potential integer overflow
**File:** `engine/MobSystem.kt` (`randomDelay`)
**Impact:** `(max - min + 1).toInt()` silently overflows if the configured range exceeds `Int.MAX_VALUE` ms (~24.8 days). The resulting negative value causes `rng.nextInt()` to throw `IllegalArgumentException`, crashing the mob wander loop. Current defaults are safe, but there is no validation guard.
**Fix:** Add a validation check in `AppConfig.validated()` that `maxWanderDelayMillis - minWanderDelayMillis <= Int.MAX_VALUE`, or use `nextLong()`.

---

## Medium Priority

### M1 — `MutableClock` test helper is shipped in the production JAR
**File:** `src/main/kotlin/dev/ambon/test/MutableClock.kt`
**Impact:** A test-only utility lives in the `src/main` source set. It is compiled into the production artifact, adds noise to the production class hierarchy, and signals to any future contributor that test utilities belong in `main`.
**Fix:** Move to `src/test/kotlin/dev/ambon/test/MutableClock.kt`. Update any imports in test files.

### M2 — No graceful shutdown hook
**File:** `Main.kt`, `MudServer.kt`
**Impact:** `main()` keeps the process alive via `delay(Long.MAX_VALUE)`. Sending SIGTERM (e.g., systemd, Docker stop, Ctrl+C) kills the JVM without calling `MudServer.stop()`. In-flight player persistence writes may be lost, and the telnet `ServerSocket` is not closed cleanly.
**Fix:**
```kotlin
Runtime.getRuntime().addShutdownHook(Thread {
    runBlocking { server.stop() }
})
```

### M3 — HP is not persisted; reconnecting heals the player
**File:** `persistence/PlayerRecord.kt`, `engine/PlayerRegistry.kt` (`bindSession`)
**Impact:** `PlayerRecord` has no `hp` field. On reconnect, `hp` is reset to `maxHp`. Equipment is also not persisted, so any `maxHp` bonus from equipped items is lost. A player can log out at 1 HP and log back in at full health.
**Assessment:** This is a known limitation rather than a crash bug. For v1.0, document it clearly. A proper fix requires adding `hp` (and optionally equipment) to `PlayerRecord`.

### M4 — Zone reset creates an item duplication opportunity
**File:** `engine/GameEngine.kt` (`resetZone`), `engine/items/ItemRegistry.kt`
**Impact:** When a zone resets, items in rooms and on mobs are cleaned and re-spawned, but items already in player inventories/equipment from that zone are not removed. A player can accumulate infinite copies of a zone item across resets.
**Assessment:** May be intentional (many MUDs allow this). If not, a fix requires scanning `inventoryItems` and `equippedItems` during reset and removing items whose origin zone matches.

### M5 — No structured logging
**Impact:** All server output is via `println`. There are no log levels, no timestamps, no log routing, and no way to filter noise in production. Some exception paths silently swallow errors (e.g., transport write loops).
**Fix:** Add SLF4J + Logback (or `kotlin-logging`). Replace `println` calls with logger calls at appropriate levels. Ensure all exception catches at least log a warning.

### M6 — `data/players` persistence path is relative and fragile
**File:** `src/main/resources/application.yaml` (`persistence.rootDir`), `config/AppConfig.kt`
**Impact:** The default path `data/players` is relative to the JVM working directory. Running the server from a different directory (systemd, Docker, IDE with a different run config) silently creates the data directory in the wrong place. Player data is not found, and new players are created as if the server is fresh.
**Fix:** Either document that the server must be started from the project root, or resolve the path against a known anchor (e.g., the JAR location, or an environment variable). At minimum, log the fully-resolved absolute path on startup.

### M7 — No tests for `RegenSystem`
**Impact:** `RegenSystem` has non-trivial logic: constitution-based interval scaling, clamping, full-HP skip. None of it is covered.
**Tests to add:** basic regen tick, constitution reducing interval, regen capping at `maxHp`, no regen when at full HP, cleanup on `onPlayerDisconnected`.

### M8 — No test for player persistence on disconnect
**Impact:** The disconnect integration test verifies room broadcast behavior but does not assert that `repo.findByName` returns the updated room/level/XP after the player disconnects. This is a production correctness claim with no regression coverage.

---

## Low Priority / Inconsistencies

### L1 — `Schedular.kt` filename typo
**File:** `engine/scheduler/Schedular.kt`
Already noted in `AGENTS.md`. Fix before v1.0 to avoid permanent technical debt. Rename file to `Scheduler.kt`.

### L2 — `RoomFile.exits` declared as `MutableMap` but backed by immutable map
**File:** `domain/world/data/RoomFile.kt`
The field is typed `MutableMap<String, String>` but initialized with `Collections.emptyMap()` (immutable). Any mutation attempt throws `UnsupportedOperationException` at runtime. Change the type to `Map<String, String>` and use Kotlin's `emptyMap()`.

### L3 — `broadcastToRoom` logic is duplicated in three places
**Files:** `GameEngine.kt`, `CombatSystem.kt`, `CommandRouter.kt`
Extract into a shared method on `PlayerRegistry` or a top-level utility.

### L4 — `idZone()` helper duplicated in `GameEngine` and `ItemRegistry`
**Files:** `GameEngine.kt`, `ItemRegistry.kt`
Identical private functions. Extract to a shared utility or add a `.zone` extension on the relevant ID types.

### L5 — `DemoConfig.webClientUrl` is `var` while all other config fields are `val`
**File:** `config/AppConfig.kt`
Stick to `val` for consistency. If mutability was needed for post-construction override, redesign the config construction instead.

### L6 — `ansiEnabled` in `PlayerRecord` is never read on reconnect
**Files:** `persistence/PlayerRecord.kt`, `persistence/YamlPlayerRepository.kt`
The field is persisted but never restored. The player's ANSI preference is lost on every reconnect. Either use it in `PlayerRegistry.bindSession` to restore the preference, or remove it from the record.

### L7 — Missing prompts on `Tell` error paths
**File:** `engine/commands/CommandRouter.kt` (Tell handling)
Two early-return paths in the `Tell` command handler (target not found; telling yourself) exit without sending `SendPrompt`. The telnet client hangs waiting for a prompt.
**Fix:** Add `outbound.send(OutboundEvent.SendPrompt(sessionId))` before each early return.

### L8 — `MudServer` fields are `val` (public) but should be `private`
**File:** `MudServer.kt`
Fields like `playerRepo`, `items`, `mobs`, `progression`, `world`, `scheduler`, `players` are all public. Nothing outside `MudServer` uses them directly. Making them `private` enforces the stated encapsulation boundary.

### L9 — Engine thread is unnamed
**File:** `MudServer.kt` line 39
`Executors.newSingleThreadExecutor()` creates a thread named `pool-1-thread-1`. In thread dumps this is unhelpful.
**Fix:** `Executors.newSingleThreadExecutor { r -> Thread(r, "ambonMUD-engine") }`

### L10 — Zone reset broadcasts "TOCK" to players
**File:** `engine/GameEngine.kt` line 160
This is a debugging artifact. Players in a resetting zone see the string "TOCK" with no context.
**Fix:** Replace with a thematic message or remove the broadcast entirely.

### L11 — Inconsistent package organization for engine subsystems
`CombatSystem`, `MobSystem`, `RegenSystem`, `PlayerProgression`, `PlayerRegistry` all live flat in `engine/`, while `commands/`, `items/`, and `scheduler/` are sub-packages. Pick one convention.

---

## Quick-Win Checklist

These are all small, contained fixes with no architectural impact:

- [ ] **C1** — Add `u/up/d/down` movement to `CommandParser.kt` (2 lines)
- [ ] **L7** — Add missing `SendPrompt` on Tell error paths (2 lines)
- [ ] **L10** — Replace "TOCK" with a real reset message (1 line)
- [ ] **L9** — Name the engine thread (1 line)
- [ ] **L1** — Rename `Schedular.kt` → `Scheduler.kt` (file rename + git mv)
- [ ] **L2** — Fix `RoomFile.exits` type to `Map<String, String>` (1 line)
- [ ] **L5** — Make `DemoConfig.webClientUrl` a `val` (1 char)
- [ ] **M1** — Move `MutableClock` to `src/test` (file move)

---

## Recommended v1.0 Scope

**Must fix before tagging v1.0:**
- C1 (players cannot use vertical exits — content is unreachable)
- H1 (password trimming — silent security boundary mutation)
- L7 (missing prompts — broken client UX)
- L10 (TOCK message — debugging artifact visible to players)

**Should fix before v1.0:**
- L1 (Schedular typo — permanent documentation debt if left)
- M1 (MutableClock in production sources)
- L9 (thread naming — good practice)
- L2 (RoomFile.exits type mismatch)

**Can defer to post-v1.0 with documentation:**
- M2 (graceful shutdown) — acceptable for a hobby server
- M3 (HP persistence) — document as known limitation
- M4 (item duplication) — assess if intentional
- M5 (logging) — add before any real production deployment
- M6 (relative persistence path) — document the working directory requirement
- M7, M8 (test gaps)
- H2 (overflow guard) — current defaults are safe; add validation as a safety net
