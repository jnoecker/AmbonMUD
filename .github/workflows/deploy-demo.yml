name: Deploy Demo

# Runs automatically after every successful CI build on main.
# SSMs into the EC2 demo instance and calls `update-ambonmud <sha>` —
# pulls the new image and restarts the systemd service in-place, so
# player YAML data on /app/data is never touched.
#
# Prerequisites (one-time setup — see docs/DEPLOYMENT.md#demo-setup):
#   GitHub variables (repo Settings → Secrets and variables → Variables):
#     AWS_EC2_DEMO_ROLE_ARN   IAM role ARN allowed to SSM into the demo instance
#     DEMO_INSTANCE_ID        EC2 instance ID (e.g. i-0abc123def456789a)
#     AWS_REGION              AWS region (default: us-east-1)

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  id-token: write   # required for OIDC AWS credential federation

jobs:
  deploy-demo:
    name: Update demo instance
    runs-on: ubuntu-latest
    # Only run if CI passed and the demo instance variable is configured.
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      vars.DEMO_INSTANCE_ID != ''
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_EC2_DEMO_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Send update command via SSM
        id: ssm
        env:
          IMAGE_TAG: ${{ github.event.workflow_run.head_sha }}
          INSTANCE_ID: ${{ vars.DEMO_INSTANCE_ID }}
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[\"update-ambonmud $IMAGE_TAG\"]" \
            --comment "Auto-deploy $IMAGE_TAG from GitHub Actions" \
            --query "Command.CommandId" \
            --output text)
          echo "command-id=$COMMAND_ID" >> "$GITHUB_OUTPUT"
          echo "Sent SSM command: $COMMAND_ID"

      - name: Wait for update to complete
        env:
          COMMAND_ID: ${{ steps.ssm.outputs.command-id }}
          INSTANCE_ID: ${{ vars.DEMO_INSTANCE_ID }}
        run: |
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID"

      - name: Print update output
        if: always()
        env:
          COMMAND_ID: ${{ steps.ssm.outputs.command-id }}
          INSTANCE_ID: ${{ vars.DEMO_INSTANCE_ID }}
        run: |
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "[Status, StatusDetails, StandardOutputContent, StandardErrorContent]" \
            --output text
